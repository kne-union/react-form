"use strict";(self.webpackChunk_kne_components_react_form=self.webpackChunk_kne_components_react_form||[]).push([[304],{24304:(e,t,r)=>{r.d(t,{c:()=>ie});var a={};r.r(a),r.d(a,{Form:()=>K,Group:()=>H,GroupList:()=>ne,RULES:()=>_,default:()=>K,formUtils:()=>se,interceptors:()=>x,preset:()=>q,useField:()=>X,useFormContext:()=>S,useGroup:()=>$,useReset:()=>Y,useSubmit:()=>ee,util:()=>oe});var n=r(49256),o=r.n(n),s=r(96312),i=r(57272),u=r(33480),c=r.n(u),l=r(6940),m=r.n(l),f=r(24872),d=r.n(f),p=r(25768),g=r.n(p),v=r(25816);const h=(0,n.createContext)({}),{Provider:b,Consumer:R}=h,S=()=>(0,n.useContext)(h),x={input:[],output:[]};x.input.use=(e,t)=>x.input.push({name:e,exec:t}),x.output.use=(e,t)=>x.output.push({name:e,exec:t});const P=x,I=(e,t,r)=>{Array.isArray(r)||(r=[r]);const a=(0,s.uniqBy)(P[t].concat((0,s.get)(e,t,[])).filter((e=>{let{name:t}=e;return r.indexOf(t)>-1})).reverse(),(e=>{let{name:t}=e;return t}));return 0===a.length?e=>e:(0,i.c)(...a.map((e=>{let{exec:t}=e;return t})))},O=e=>Object.values(e).every((e=>e.isPass));function D(){return D=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},D.apply(this,arguments)}function k(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}class F{constructor(e){let{id:t,name:r}=e;this.id=t,this.name=r,this.isPass=!1,this.validate={}}setInfo(e){let{groupName:t,groupIndex:r,label:a,rule:n,interceptor:o,noTrim:s,fieldRef:i,errMsg:u}=e;return this.groupName=t,this.groupIndex=r,this.label=a,this.rule=n,this.interceptor=o,this.noTrim=s,this.fieldRef=i,this.errMsg=u,this}deleteValue(){return delete this.value,this}setValue(e){return this.value=e,this}clone(){return(0,s.clone)(this)}setValidateStatus(e){let{status:t,msg:r="",validateData:a}=e;return this.validate={status:t,msg:r,validateData:Object.assign({},this.validate.validateData,a)},this}async runValidate(e,t){const r=await(async e=>{let{field:t,value:r,formRules:a,getFormData:n}=e;if("function"===typeof t.rule)return await t.rule(r,Object.assign({},{data:n()},{field:t}));if("object"===typeof t.rule&&t.rule instanceof RegExp)return{result:t.rule.test(r),errMsg:""};const o={};if("string"===typeof t.rule){const e=t.rule.split(" ").filter((e=>e.length>0));for(let s of e){let[e,...i]=s.split("-");const u=a[e.toUpperCase()];if("function"===typeof u){if("REQ"!==s&&!0!==a.REQ(r,...i,Object.assign({},{data:n()},{field:t})).result)return{result:!0,errMsg:"",data:o};const c=await u(r,...i,Object.assign({},{data:n()},{field:t}));if(Object.assign(o,{[e.toUpperCase()]:c.data}),!0!==c.result)return{result:!1,errMsg:c.errMsg,data:o}}else console.error("\u6821\u9a8c\u89c4\u5219".concat(s,"\u4e0d\u5728\u5f53\u524dform\u7684rules\u91cc\u9762\uff0c\u8bf7\u786e\u8ba4").concat(t.name,"\u7684\u6821\u9a8c\u89c4\u5219").concat(t.rule,"\u662f\u5426\u6b63\u786e"))}}return{result:!0,errMsg:"",data:o}})({field:this.clone(),value:this.value,formRules:e,getFormData:t});return this.isPass=r.result,this.validate={status:!0===r.result?1:2,msg:r.errMsg,validateData:Object.assign({},r.data)},this}}class j{constructor(e){let{id:t,runner:r,complete:a}=e;this.id=t,this.isCancel=!1,this.target=Promise.race([Promise.resolve(r()),new Promise((e=>{this.resolve=e}))]).then((e=>this.isCancel?new Promise((()=>{})):e)),this.target.then((function(){return Promise.resolve(a(...arguments))}))}cancel(){!0!==this.isCancel&&(this.isCancel=!0,this.resolve(...arguments))}}class y{constructor(){this.queue=[]}append(e){const t=new Proxy(e.complete,{apply:(e,t,a)=>{const n=e.apply(t,a),o=this.queue.indexOf(r);return this.queue.splice(o,1),n}});e.complete=t;const r=new j(e),a=this.queue.find((e=>{let{id:t}=e;return r.id===t}));if(a){const e=this.queue.indexOf(a);a.cancel(),this.queue.splice(e,1)}this.queue.push(r)}}const E=(e,t)=>t.id?e[t.id]:t.groupName?Object.values(e).find((e=>e.name===t.name&&e.groupName===t.groupName&&e.groupIndex===t.groupIndex)):Object.values(e).find((e=>e.name===t.name)),N=e=>{let{formStateRef:t,formDataRef:r,setFormState:a,otherProps:n,taskQueue:o,emitter:s}=e;const i=e=>{e.fieldRef.current&&a(Object.assign({},t.current,{[e.id]:e}))};return e=>{let{id:a,name:u,groupName:c,groupIndex:l}=e;const m=E(t.current,{id:a,name:u,groupName:c,groupIndex:l});if(!m)return void console.error("\u672a\u627e\u5230\u8981\u6c42\u5b57\u6bb5");const f=m.clone();f.setValidateStatus({status:3}),i(f);let d=f.value;"string"===typeof f.value&&!0!==f.noTrim&&(d=f.value.trim(),f.value!==d&&(f.setValue(d),s.emit("form-field-data-change",{id:a,value:d}))),o.append({id:a,runner:()=>f.runValidate(n.current.rules,(()=>r.current)),complete:()=>{i(f),s.emit("form-field-validate-complete",{id:a,name:f.name,value:d,index:f.groupIndex,validate:f.validate})}})}},M=e=>{let{formStateRef:t,taskQueue:r,emitter:a}=e;return e=>(e=Object.assign({},e),Object.values(t.current).forEach((e=>{a.emit("form-field-validate",{id:e.id})})),Promise.all(r.queue.map((e=>e.target))).then((function(){return e.callback&&e.callback({formState:t.current})})))},C=e=>{let{setFormState:t,formStateRef:r,initDataRef:a,formDataRef:n,taskQueue:o,emitter:s,otherProps:i}=e;const u=N({formStateRef:r,formDataRef:n,setFormState:t,otherProps:i,taskQueue:o,emitter:s});return(e,n)=>{const{runValidate:o}=Object.assign({},{runValidate:!0},n),s=Object.assign({},r.current),c=[];e.forEach((e=>{const{name:t,groupName:r,groupIndex:n,value:o,validate:u,toInitData:l}=Object.assign({},{toInitData:!1},e),f=E(s,{name:t,groupName:r,groupIndex:n});if(f)return s[f.id]=f.clone().setValue(I(i.current.interceptors,"input",f.interceptor)(o)),void(u?s[f.id].setValidateStatus(u):c.push(f.id));if(r&&g()(n)){const e=(p=s,(v={groupName:r,name:t}).groupName?Object.values(p).filter((e=>e.name===v.name&&e.groupName===v.groupName)):[]);e.forEach((e=>{s[e.id]=e.clone().setValue(I(i.current.interceptors,"input",e.interceptor)(o)),u?s[e.id].setValidateStatus(u):c.push(e.id)}))}else{var p,v;if(l){if(r&&d()(r.split("."))===t&&!g()(n))return void m()(a.current,"".concat(r,'["').concat(n,'"]'),o);if(r&&t&&!g()(n))return void m()(a.current,"".concat(r,'["').concat(n,'"].').concat(t),o);if(t)return void m()(a.current,t,o)}}})),t(s),o&&c.forEach((e=>u({id:e})))}},V=e=>{if((0,s.isPlainObject)(e)){const t=(0,s.values)(e);return t.length>0&&t.some((e=>!!e))}return(0,s.isArray)(e)?e.length>0:"number"===typeof e?!isNaN(e):!(void 0===e||null===e||""===e||0===e.length)},L=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if((0,s.isArray)(e))return e.map((e=>L(e))).filter(V);if((0,s.isPlainObject)(e)){const t={};return Object.keys(e).forEach((r=>{const a=L(e[r]);V(a)&&(t[r]=a)})),t}return e},w=(e,t)=>"string"===typeof e?e.replace("%s",t):e(t),A=e=>Object.values(e).filter((e=>2===(0,s.get)(e,"validate.status"))).map((e=>Object.assign({},e.validate,{name:e.name,label:e.label,groupName:e.groupName,fieldRef:e.fieldRef,groupIndex:e.groupIndex,errMsg:w(e.errMsg||(0,s.get)(e,"validate.msg",""),e.label)}))),Q=["debug","formStateRef","formData","formDataRef","computedIsPassRef","initDataRef"],T=e=>{let{debug:t,formStateRef:r,formData:a,formDataRef:o,initDataRef:i}=e,u=k(e,Q);const l=c()({debug:t,name:"react-form"}),f=(0,n.useRef)(l);f.current=l;const p=(e=>{const t=(0,n.useRef)({});return Object.keys(e).forEach((r=>{t.current[r]=e[r]})),t})(u);return p.current=u,(0,n.useEffect)((()=>{const e=f.current,t=p.current.setFormState,a=new y;return e.addListener("form-field-add",(e=>{let{formStateRef:t,setFormState:r}=e;return e=>{let{id:a,name:n}=e;const o=new F({id:a,name:n});r(Object.assign({},t.current,{[a]:o}))}})({formStateRef:r,setFormState:t})),e.addListener("form-field-edit",(e=>{let{formStateRef:t,setFormState:r,initDataRef:a,otherProps:n}=e;return e=>{let{id:o,name:i,rule:u,label:c,interceptor:l,value:m,noTrim:f,groupName:d,groupIndex:p,fieldRef:g,errMsg:v}=e;const h=t.current[o].clone();h.setInfo({groupName:d,groupIndex:p,label:c,rule:u,interceptor:l,noTrim:f,fieldRef:g,errMsg:v}),void 0===h.value&&h.setValue(I(n.current.interceptors,"input",l)(m||(d&&(0,s.last)(d.split("."))===i?(0,s.get)(a.current,"".concat(d,'["').concat(p,'"]')):d?(0,s.get)(a.current,"".concat(d,'["').concat(p,'"].').concat(i)):(0,s.get)(a.current,i)))),r(Object.assign({},t.current,{[o]:h}))}})({formStateRef:r,setFormState:t,initDataRef:i,otherProps:p})),e.addListener("form-field-remove",(e=>{let{formStateRef:t,setFormState:r}=e;return e=>{let{id:a}=e;const n=Object.assign({},t.current);delete n[a],r(n)}})({formStateRef:r,setFormState:t})),e.addListener("form-field-validate",N({formStateRef:r,formDataRef:o,setFormState:t,otherProps:p,taskQueue:a,emitter:e})),e.addListener("form-field-data-change",(e=>{let{formStateRef:t,setFormState:r}=e;return e=>{let{id:a,value:n}=e;if(!t.current[a])return;const o=t.current[a].clone();o.setValue(n),o.setValidateStatus({status:0}),r(Object.assign({},t.current,{[a]:o}))}})({formStateRef:r,setFormState:t})),e.addListener("form-data-set",(e=>{let{setFormState:t,formStateRef:r,initDataRef:a,otherProps:n,taskQueue:o,emitter:i}=e;const u=M({formStateRef:r,taskQueue:o,emitter:i});return e=>{let{data:o,runValidate:i=!0}=e;a.current=o;const c={};Object.values(Object.assign({},r.current)).forEach((e=>{const t=e.clone(),r=t.groupName,a=t.groupIndex,i=t.name,u=r&&(0,s.last)(r.split("."))===i?(0,s.get)(o,"".concat(r,"[").concat(a,"]")):r?(0,s.get)(o,"".concat(r,"[").concat(a,"].").concat(i)):(0,s.get)(o,i);t.setValue(I(n.current.interceptors,"input",e.interceptor)(u)),c[t.id]=t})),t(c),i&&u()}})({setFormState:t,formStateRef:r,initDataRef:i,otherProps:p,taskQueue:a,emitter:e})),e.addListener("form-data-reset",(e=>{let{initDataRef:t,setFormState:r,formStateRef:a}=e;return()=>{t.current={};const e=Object.assign({},a.current),n={};Object.values(e).forEach((e=>{const t=e.clone();t.deleteValue(),t.validate={},n[e.id]=t})),r(n)}})({initDataRef:i,setFormState:t,formStateRef:r})),e.addListener("form-data-set-field",(e=>{let{setFormState:t,formStateRef:r,initDataRef:a,formDataRef:n,taskQueue:o,emitter:s,otherProps:i}=e;const u=N({formStateRef:r,formDataRef:n,setFormState:t,otherProps:i,taskQueue:o,emitter:s});return e=>{let{name:n,groupName:o,groupIndex:s,value:c,runValidate:l=!0}=e;console.warn("form-data-set-field\u4e8b\u4ef6\u5df2\u7ecf\u5e9f\u5f03\u76ee\u524d\u6682\u65f6\u517c\u5bb9\uff0c\u540e\u7eed\u7248\u672c\u53ef\u80fd\u4f1a\u5220\u9664,\u8bf7\u4f7f\u7528form-data-set-field-list\u4e8b\u4ef6\u4ee3\u66ff");const f=Object.assign({},r.current),p=o?Object.values(f).find((e=>e.name===n&&e.groupName===o&&e.groupIndex===s)):Object.values(f).find((e=>e.name===n));if(!p)return o&&d()(o.split("."))===n?void m()(a.current,"".concat(o,'["').concat(s,'"]'),c):o?void m()(a.current,"".concat(o,'["').concat(s,'"].').concat(n),c):void m()(a.current,n,c);f[p.id]=p.clone().setValue(I(i.current.interceptors,"input",p.interceptor)(c)),t(f),l&&u({id:p.id})}})({setFormState:t,formStateRef:r,initDataRef:i,formDataRef:o,taskQueue:a,emitter:e,otherProps:p})),e.addListener("form-data-set-field-list",C({setFormState:t,formStateRef:r,initDataRef:i,formDataRef:o,taskQueue:a,emitter:e,otherProps:p})),e.addListener("form-data-set-field-validate",(e=>{let{setFormState:t,formStateRef:r,emitter:a}=e;return e=>{let{name:n,groupName:o,groupIndex:s,validate:i}=e;const u=Object.assign({},r.current),c=E(u,{name:n,groupName:o,groupIndex:s});if(!c)return void console.error("\u672a\u627e\u5230\u8981\u6c42\u5b57\u6bb5");const l=c.clone();l.setValidateStatus(i),t(Object.assign({},u,{[l.id]:l})),a.emit("form-field-validate-complete",{id:l.id,name:l.name,value:l.value,index:l.groupIndex,validate:l.validate})}})({setFormState:t,formStateRef:r,emitter:e})),e.addListener("form-validate-all",M({formStateRef:r,taskQueue:a,emitter:e})),e.addListener("form-submit",(e=>{let{formStateRef:t,formDataRef:r,taskQueue:a,otherProps:n,emitter:o}=e;const s=M({formStateRef:t,taskQueue:a,emitter:o});return e=>{Array.isArray(e)||(e=[e]);const{onPrevSubmit:a,onError:i,onComplete:u,onSubmit:c,noFilter:l}=n.current;s().then((async()=>{const n=t.current;if(!O(n)){const t=A(n);return o.emit("form-submit-error",t),i&&await i(t,...e),!1}const s=!0===l?r.current:L(r.current);return o.emit("form-prev-submit"),a&&!1===await a(s,...e)?(o.emit("form-prev-submit-error"),!1):(c&&await c(s,...e),o.emit("form-submit-success",s),!0)})).then((e=>{o.emit("form-submit-end",e)}),(t=>(console.error(t),o.emit("form-error",t),i&&i(t,...e)))).then((()=>{const e=t.current,a=O(e),n=!0===l?r.current:L(r.current),s=A(e);return o.emit("form-submit-complete",{formData:n,isPass:a,errors:s}),u&&u({formData:n,isPass:a,errors:s})}))}})({formStateRef:r,formDataRef:o,taskQueue:a,otherProps:p,emitter:e})),()=>{e.removeAllListeners()}}),[r,i,p]),(0,n.useMemo)((()=>{f.current.emit("form-data-change",{data:a})}),[a]),l},_={REQ:function(e){return{result:V(e),errMsg:""}},TEL:function(e){return{result:/^1[0-9]{10}$/.test(e),errMsg:"\u8bf7\u8f93\u5165\u6709\u6548\u7684\u624b\u673a\u53f7"}},EMAIL:function(e){return{result:/^([a-zA-Z0-9_.-])+@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(e),errMsg:"\u8bf7\u8f93\u5165\u6709\u6548\u7684\u90ae\u7bb1"}},LEN:function(e,t,r){return e=e.toString(),r===t&&e.length!==Number(r)?{result:!1,errMsg:"%s\u957f\u5ea6\u5fc5\u987b\u7b49\u4e8e".concat(r)}:e.length<t?{result:!1,errMsg:"%s\u957f\u5ea6\u5fc5\u987b\u5927\u4e8e".concat(t)}:r&&e.length>r?{result:!1,errMsg:"%s\u957f\u5ea6\u5fc5\u987b\u5c0f\u4e8e".concat(r)}:{result:!0}}},q=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(_,e)},B=(0,n.createContext)(),{Provider:U}=B,G=()=>(0,n.useContext)(B),z=(e,t)=>"".concat(e,"@").concat(t),Z=e=>{let{children:t}=e;const r=(0,n.useMemo)((()=>(0,s.uniqueId)("group_")),[]),a=G(),[i,u]=(0,n.useState)({}),{emitter:c}=S();return(0,n.useEffect)((()=>{const e=c.addListener("form-group-add",(e=>{let{id:t,parentId:r,name:a}=e;u((e=>{const n=Object.assign({},e),o=z(r,a);n[o]||(n[o]=[]);const s=n[o].slice(0);return s.push(t),n[o]=s,n}))})),t=c.addListener("form-group-remove",(e=>{let{id:t,parentId:r,name:a}=e;u((e=>{const n=Object.assign({},e),o=z(r,a),s=n[o].slice(0),i=s.indexOf(t);return s.splice(i,1),n[o]=s,n}))}));return()=>{e.remove(),t.remove()}}),[c]),o().createElement(U,{value:Object.assign({},a,{id:r,groupMap:i})},t)},H=e=>{let{name:t,children:r}=e;const{formIsMount:a,emitter:i}=S(),u=(0,n.useMemo)((()=>(0,s.uniqueId)("group_")),[]),{id:c,index:l,groupMap:m,name:f}=G(),d=(0,n.useMemo)((()=>(0,s.get)(m,z(c,t),[]).indexOf(u)),[u,c,m,t]),p=(0,n.useMemo)((()=>d>-1&&f?"".concat(f,"[").concat(l,"].").concat(t):t),[f,t,d,l]);return(0,n.useEffect)((()=>{let e=!1;return a&&(e=!0,i.emit("form-group-add",{id:u,parentId:c,name:t})),()=>{e&&i.emit("form-group-remove",{id:u,parentId:c,name:t})}}),[a,i,u,c,t]),o().createElement(U,{value:{id:u,name:p,groupMap:m,index:d}},r)},$=G,K=(0,n.forwardRef)(((e,t)=>{const{formState:r,formStateRef:a,formData:i,fields:u,isPass:c,isPassRef:l,formDataRef:m,setFormState:f}=(e=>{const[t,r]=(0,n.useState)({}),a=(0,n.useRef)({});a.current=t;const o=(0,n.useRef)({});o.current=e;const i=(0,n.useMemo)((()=>Object.values(t).map((e=>({field:e.fieldRef,label:e.label,name:e.name,rule:e.rule})))),[t]),u=(0,n.useMemo)((()=>O(t)),[t]),c=(0,n.useMemo)((()=>{const e={};return Object.values(t).forEach((t=>{if(!t.name)return;const r=I(o.current.interceptors,"output",t.interceptor)(t.value);t.groupName&&(0,s.last)(t.groupName.split("."))===t.name?(0,s.set)(e,"".concat(t.groupName,"[").concat(t.groupIndex,"]"),r):t.groupName?(0,s.set)(e,"".concat(t.groupName,"[").concat(t.groupIndex,"].").concat(t.name),r):(0,s.set)(e,t.name,r)})),e}),[t]),l=(0,n.useRef)({});return l.current=c,{fields:i,isPass:u,formData:c,formDataRef:l,formState:t,formStateRef:a,setFormState:e=>{a.current=e,r(e)}}})(e),d=(0,n.useRef)(e.data),[p,g]=(0,n.useState)(!1),v=Object.assign({},_,e.rules),h=T({onPrevSubmit:e.onPrevSubmit,rules:v,interceptors:e.interceptors,noFilter:e.noFilter,onError:e.onError,onSubmit:e.onSubmit,debug:e.debug,formState:r,formStateRef:a,formData:i,isPassRef:l,formDataRef:m,setFormState:f,initDataRef:d}),R=(0,n.useRef)(h);R.current=h,(0,n.useEffect)((()=>(g(!0),d.current&&R.current.emit("form-data-set",{data:d.current}),R.current.emit("form-mount"),()=>{R.current.emit("form-unmount")})),[]);const S=(e=>{let{emitter:t,fields:r,formState:a,formData:o,isPass:s}=e;return(0,n.useMemo)((()=>({emitter:t,submit:function(){for(var e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];t.emit("form-submit",r)},get isPass(){return s},get data(){return o},get fields(){return r},get formState(){return a},set data(e){t.emit("form-data-set",{data:e})},get errors(){return A(a)},reset(){t.emit("form-data-reset")},onReady(e){t.addListener("form-mount",(()=>{e&&e()}))},onDestroy(e){t.addListener("form-unmount",(()=>{e&&e()}))},validateField(e){let{name:r,groupName:a,groupIndex:n}=e;t.emit("form-field-validate",{name:r,groupName:a,groupIndex:n})},validateAll:()=>new Promise((e=>{t.emit("form-validate-all",{callback:t=>{let{formState:r}=t;e({isPass:O(r),errors:A(r)})}})})),setFormData:function(e){let r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];t.emit("form-data-set",{data:e,runValidate:r})},getFormData:()=>o,setFieldValidate(e){let{name:r,validate:a,groupName:n,groupIndex:o}=e;t.emit("form-data-set-field-validate",{name:r,groupName:n,groupIndex:o,validate:a})},setField(e){let{name:r,value:a,groupName:n,groupIndex:o,validate:s,runValidate:i=!0}=e;t.emit("form-data-set-field-list",[{name:r,groupName:n,groupIndex:o,value:a,validate:s}],{runValidate:i})},setFields(e,r){t.emit("form-data-set-field-list",e,r)}})),[t,r,a,s,o])})({emitter:h,fields:u,formState:r,setFormState:f,formData:i,isPass:c});return(0,n.useImperativeHandle)(t,(()=>S),[S]),o().createElement(b,{value:{formState:r,formData:i,setFormState:f,emitter:h,fields:u,isPass:c,formIsMount:p,initDataRef:d,openApi:S}},o().createElement(Z,null,e.children))}));K.defaultProps={data:{},debug:!1,rules:{},interceptors:{}};const J=(e,t)=>{if((e=>window.Event&&(e instanceof window.Event||(0,s.get)(e,"nativeEvent")instanceof window.Event||"function"===typeof(0,s.get)(e,"preventDefault")))(e)){if(void 0===t)switch(e.target.type){case"checkbox":case"radio":t=e.target.checked;break;default:t=e.target.value}}else t=e;return t},W=["name","rule","label","interceptor","noTrim","debounce","onChange","value","errMsg"],X=e=>{let{name:t,rule:r,label:a,interceptor:o,noTrim:i,debounce:u=0,onChange:c,value:l,errMsg:m}=e,f=k(e,W);const d=$(),p=(0,s.get)(d,"name"),g=(0,s.get)(d,"index"),{formState:h,formData:b}=S(),R=(0,n.useMemo)((()=>(0,s.uniqueId)("".concat(t,"_"))),[t]),x=(0,s.get)(h,R),P=(e=>{let{name:t,rule:r,label:a,interceptor:o,noTrim:s,value:i,id:u,groupName:c,groupIndex:l,errMsg:m}=e;const f=(0,n.useRef)(null),{formIsMount:d,emitter:p}=S();return(0,n.useEffect)((()=>{let e=!1;return d&&(e=!0,p.emit("form-field-add",{name:t,id:u})),()=>{e&&p.emit("form-field-remove",{id:u})}}),[d,p,t,u]),(0,n.useEffect)((()=>{d&&-1!==l&&p.emit("form-field-edit",{name:t,rule:r,label:a,interceptor:o,noTrim:s,id:u,groupName:c,groupIndex:l,value:i,fieldRef:f,errMsg:m})}),[d,p,t,r,a,o,s,u,c,l,i,f,m]),f})({name:t,rule:r,label:a,interceptor:o,noTrim:i,value:l,id:R,groupName:p,groupIndex:g,errMsg:m}),I=(e=>{let{name:t,id:r,time:a}=e;const{formIsMount:o,emitter:s}=S(),i=()=>{o&&s.emit("form-field-validate",{name:t,id:r})},u=(0,v.yK)(i,a),c=u.cancel;return(0,n.useEffect)((()=>{const e=s.addListener("form-data-reset",c);return()=>{e&&e.remove()}}),[s,c]),a?u:i})({name:t,id:R,time:u}),{isValueChanged:O,onChange:F}=(e=>{let{name:t,id:r,onChange:a}=e;const{emitter:o}=S(),[s,i]=(0,n.useState)(!1);return{isValueChanged:s,onChange:function(){a&&a(...arguments),i(!0);const e=J(...arguments);o.emit("form-field-data-change",{name:t,value:e,id:r})}}})({name:t,id:R,onChange:c});return D({},f,{id:R,name:t,label:a,fieldRef:P,formData:b,formState:h,rule:r,groupName:p,groupIndex:g,onChange:F,isValueChanged:O,value:(0,s.get)(x,"value"),triggerValidate:I,errState:(0,s.get)(x,"validate.status",0),errMsg:w(m||(0,s.get)(x,"validate.msg",""),a)})},Y=()=>{const{emitter:e}=S();return{onClick:(0,n.useCallback)((()=>{e.emit("form-data-reset")}),[e])}},ee=e=>{const[t,r]=(0,n.useState)(!1),{isPass:a,emitter:o}=S(),{onClick:s}=Object.assign({},e);return(0,n.useEffect)((()=>{const e=o.addListener("form-submit-complete",(()=>{r(!1)}));return()=>{e&&e.remove()}}),[o]),{isLoading:t,isPass:a,onClick:(0,n.useCallback)((function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];r(!0),setTimeout((()=>{Promise.resolve(s&&s(...t)).then((e=>{o.emit("form-submit",e||t)}),(()=>{r(!1)}))}),0)}),[o,r])}},te=(0,n.createContext)({}),{Provider:re}=te,ae=e=>{let{children:t}=e;const{index:r}=G();return t({index:r})},ne=(0,n.forwardRef)(((e,t)=>{let{name:r,defaultLength:a,empty:i,children:u}=e;const[c,l]=(0,n.useState)([]),{initDataRef:m,emitter:f}=S(),d=G()||{},{name:p,index:g}=d,v=(0,n.useMemo)((()=>g>-1&&p?"".concat(p,"[").concat(g,"]"):""),[p,g]),h=(0,n.useRef)(d);h.current=d;const b=(0,n.useRef)();b.current=v?"".concat(v,".").concat(r):r;const R=(0,n.useRef)(a);(0,n.useEffect)((()=>{const e=e=>{const t=h.current.id,r=(e,r)=>t?"".concat(t,"-").concat(r):r;return Number.isInteger(R.current)&&R.current>0&&!(Array.isArray(e)&&e.length>=R.current)?(0,s.range)(0,R.current).map(r):Array.isArray(e)?e.map(r):[]};l((()=>{const t=(0,s.get)(m.current,v?"".concat(v,".").concat(r):r);return e(t)}));const t=f.addListener("form-data-set",(t=>{let{data:a}=t;l((()=>{const t=(0,s.get)(a,v?"".concat(v,".").concat(r):r);return e(t)}))}));return()=>{t.remove()}}),[f,v,r]);const x=(0,n.useCallback)((e=>{const{isUnshift:t}=Object.assign({},e),r=h.current.id;l((e=>{if(0===e.length)return["".concat(r,"-0")];const a=e.slice(0),n=Math.max(parseInt((0,s.last)(e[0].split("-"))),parseInt((0,s.last)((0,s.last)(e).split("-"))))+1;return a[t?"unshift":"push"](r?"".concat(r,"-").concat(n):n),a}))}),[]),P=(0,n.useCallback)((e=>{l((t=>{const r=t.indexOf(e),a=(0,s.get)(m.current,b.current);Array.isArray(a)&&a.splice(r,1);const n=t.slice(0);return n.splice(r,1),n}))}),[]);return(0,n.useImperativeHandle)(t,(()=>({onAdd:x,onRemove:P}))),o().createElement(re,{value:{onAdd:x,onRemove:P}},0===c.length?i:c.map((e=>o().createElement(H,{key:e,name:r},o().createElement(ae,null,(t=>{let{index:r}=t;return u(e,{index:r,length:c.length,onAdd:x,onRemove:()=>P(e)})}))))))}));ne.defaultProps={empty:null},ne.useAction=()=>(0,n.useContext)(te);const oe={isNotEmpty:V,isEmpty:e=>!V(e),filterEmpty:L,stateToIsPass:O,stateToError:A,compileErrMsg:w,getField:E},se=oe,ie={name:"react-form",summary:"<p>\u7528\u4e8e\u8868\u5355\u9a8c\u8bc1</p>\n<h4>\u7279\u70b9</h4>\n<ul>\n<li>UI\u5206\u79bb\uff0c\u652f\u6301\u81ea\u5b9a\u4e49UI\u6846\u67b6\u3002\u63d0\u4f9b\u4e86antd\u7684\u7ec4\u4ef6\u5c01\u88c5 @kne/react-form-antd \u548c taro\u7684\u7ec4\u4ef6\u5c01\u88c5 @kne/react-form-taro</li>\n<li>\u5206\u7ea7\u6821\u9a8c\u89c4\u5219\u914d\u7f6e\uff0c\u6821\u9a8c\u89c4\u5219\u652f\u6301\u5f02\u6b65\u6821\u9a8c</li>\n<li>\u4e8b\u4ef6\u9a71\u52a8\uff0c\u65b9\u4fbf\u7075\u6d3b\u6269\u5c55\u3002\u53ef\u4ee5\u901a\u8fc7debug\u9009\u9879\u914d\u7f6e\uff0c\u901a\u8fc7\u89e6\u53d1\u4e8b\u4ef6\u987a\u5e8f\u548c\u53c2\u6570\u8f7b\u677e\u8c03\u8bd5</li>\n<li>\u652f\u6301\u5305\u542bGroup\u7684\u590d\u6742\u8868\u5355\uff0c\u5b50\u8868\u5355</li>\n</ul>",description:"\u7528\u4e8e\u8868\u5355\u9a8c\u8bc1\u7684react\u7ec4\u4ef6",packageName:"@kne/react-form",api:"",example:{isFull:!1,className:"react_form_5f21f",style:"",list:[{title:"\u8fd9\u91cc\u586b\u5199\u793a\u4f8b\u6807\u9898",description:"\u8fd9\u91cc\u586b\u5199\u793a\u4f8b\u8bf4\u660e",code:"const { default: Form, useField, useSubmit, useReset } = reactForm;\n\nconst Input = props => {\n  const fieldProps = useField(props);\n  return (<div>\n    {fieldProps.label}\n    <input ref={fieldProps.fieldRef} type='text' value={fieldProps.value || ''} onChange={fieldProps.onChange}\n           onBlur={fieldProps.triggerValidate} />\n    {fieldProps.errState}\n    {fieldProps.errMsg}\n  </div>);\n};\n\nconst SubmitButton = ({ children }) => {\n  const { isLoading, onClick } = useSubmit();\n  return (<button onClick={onClick}>\n    {children}\n    {isLoading ? '\u6b63\u5728\u63d0\u4ea4\u4e2d...' : ''}\n  </button>);\n};\n\nconst ResetButton = () => {\n  const { onClick } = useReset();\n  return <button onClick={onClick}>\u91cd\u7f6e</button>;\n};\n\nconst Example = ()=>{\n  return <Form>\n    <Input name=\"name\" label=\"\u540d\u79f0\" rule=\"REQ LEN-0-10\"/>\n    <div>\n      <SubmitButton>\u63d0\u4ea4</SubmitButton>\n      <ResetButton>\u91cd\u7f6e</ResetButton>\n    </div>\n  </Form>\n};\n\nrender(<Example />);\n\n",scope:[{name:"reactForm",packageName:"@kne/react-form",component:a}]}]}}}}]);
//# sourceMappingURL=304.e235e750.chunk.js.map